
<%- include('../layouts/header.ejs') %>

<section class="p-3">

</section>
<form action="/checkout" method="POST" id="checkoutForm"> <!-- Replace "/your-submit-action" with the actual action URL -->
    <div class="container mt-5">
        <h2 class="mb-4">Checkout</h2>

        <div class="row">
            <!-- Billing Address Section -->
            <div class="col-md-6 mb-4">
                <h4>Billing Address</h4>
                <% if (userAddress && userAddress.addresses.length > 0) { %>
                    <!-- Display Other Addresses with Cards -->
                    <% userAddress.addresses.forEach((addr, index) => { %>
                      <div class="card mb-3">
                        <div class="card-body">
                          <div class="form-check">
                            <input class="form-check-input" type="radio" name="selectedAddress" id="address<%= index %>" value="<%= addr._id %>" <%= index === 0 ? 'checked' : '' %>>
                            <label class="form-check-label" for="address<%= index %>">
                              <%= addr.name %><br>
                              <%= addr.address %><br>
                              <%= addr.localityTown %>, <%= addr.city %>, <%= addr.state %>
                            </label>

                            
                          </div>
                        </div>
                      </div>
                    <% }); %>
                  <% } %>
                 
                  <div class="card-body">
                    <!-- Add Address Button -->
                    <a href="/addaddress" class="btn btn-primary">Add Address</a>
                </div>

                  
                <div class="card-body">
                    <!-- Dummy Payment Options -->
                    <div class="mb-3">
                        <h5>Select Payment Option:</h5>
                        <!-- <div class="form-check">
                            <input class="form-check-input" type="radio" name="paymentOption" id="creditCard" value="creditCard" checked>
                            <label class="form-check-label" for="creditCard">
                                Credit Card
                            </label>
                        </div> -->
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="paymentOption" id="razorpay" value="razorpay" checked>
                            <label class="form-check-label" for="razorpay">
                                Razorpay
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="paymentOption" id="cod" value="COD">
                            <label class="form-check-label" for="cod">
                                COD
                            </label>
                        </div>
                        <div class="form-check">
                          <input class="form-check-input" type="radio" name="paymentOption" id="wallet" value="wallet">
                          <label class="form-check-label" for="wallet">
                              Wallet Payment
                          </label>
                      </div>
                      <span id="showError" style="display: none; color: red;" class="mt-3">Insufficient fund</span>
                    </div>
                </div>
            </div>

            <!-- Order Summary Section -->
            <div class="col-md-6 order-summary text-right">
                <h4>Order Summary</h4>

                <% userCart.forEach(cartItem => { %>
                    <div class="media mb-4">
                        <img src="/ProductImages/<%= cartItem.productDetails.images[0] %>" class="img-thumbnail mr-3" alt="Product Image" style="max-width: 75px; max-height: 75px;">
                        <div class="media-body">
                            <h5 class="mt-0"><%= cartItem.productDetails.name %></h5>
                            <p>Quantity: <%= cartItem.items.quantity %></p>
                            <p>Price: ₹<%= cartItem.items.price.toFixed(2) %></p>
                        </div>
                    </div>
                <% }); %>

                <!-- Display total price -->
                <p>Total Price: ₹<%= userCart[0].totalPrice %></p>


                <!-- Add a hidden input to store the total price -->
                <input type="hidden" name="totalPrice" value="<%= userCart[0].totalPrice %>">

                <p>Discounted Price: ₹<%= userCart[0].counponPrice > 0 ? userCart[0].counponPrice : '0' %></p>

                <!-- Add a hidden input to store the total price -->
                <input type="hidden" name="totalPrice" value="<%= userCart[0].counponPrice > 0 ? userCart[0].counponPrice : userCart[0].totalPrice %>">

                <!-- Place Order Button -->
                <!-- <button  class="btn btn-primary btn-lg btn-block" data-toggle="modal" data-target="#addressPaymentModal" onclick="confirmRazorpayPayment()">
                    Place Order
                </button> -->

                <button class="btn btn-primary btn-lg btn-block" data-toggle="modal" data-target="#addressPaymentModal" onclick="handlePayment()">
                  Place Order
              </button>
              <div class="card rounded-0 mt-3">

          
             
               </div> 
            </div>
        </div>
    </div>
</form>
<% 
if (typeof message !== 'undefined') {
    %>
    <p style="color: red;"><%= message %></p>
    <%
}
%>


<!-- Add this somewhere in your EJS template where you want to display the message -->
<% if (insufficient) { %>
    <div class="alert alert-danger" role="alert">
        <%= insufficient %>
    </div>
<% } %>


<div class="container mt-5">
    <div class="row">
        <div class="col-md-4">
            <% if (req.query.couponused) { %>
                <div class="card mt-4">
                    <div class="card-body">
                        <form action="/cancelCoupon?counponId=<%= req.query.couponId %>" method="post" id="cancelCouponForm">
                            <input type="hidden" name="counponId" value="<%= req.query.couponId %>">
                            <div class="card" id="couponCard">
                                <p class="m-3">Used coupon: <%= req.query.couponused %></p>
                                <button class="btn btn-dark btn-sm" type="submit">
                                    <div class="btn-close wishlist-close"></div>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            <% } else if (req.query.message) { %>
                <div class="card mt-4">
                    <div class="card-body">
                        <div class="alert alert-danger" role="alert">
                            <%= req.query.message %>
                        </div>
                    </div>
                </div>
            <% } %>

            <div class="card mt-3">
                <div class="card-body">
                    <form action="/applycoupon" method="post">
                        <h5 class="fw-bold mb-4">Apply Coupon</h5>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" placeholder="Enter coupon code" name="couponCode">
                            <button class="btn btn-dark rounded-0" type="submit">Apply</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Other content in the right column if any -->
        <div class="col-md-8">
            <!-- Your existing content on the right side goes here -->
        </div>
    </div>
</div>


  

  

<!-- Add this script tag to your HTML -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
function checkAddressSelection() {
    // Check if any address is selected
    const selectedAddress = document.querySelector('input[name="selectedAddress"]:checked');

    if (!selectedAddress) {
        // If no address is selected, show a message
        alert('Please add/select an address.');
    } else {
        // If an address is selected, you can perform additional actions if needed
        console.log('Address selected:', selectedAddress.value);
    }
}

function handlePayment() {
  event.preventDefault();  // Prevent default form submission behavior

  const selectedAddress = document.querySelector('input[name="selectedAddress"]:checked');

if (!selectedAddress) {
    // If no address is selected, show a message and return
    alert('Please add/select an address before proceeding with the payment.');
    return
}

        // Check if Razorpay option is selected
        var razorpayOption = document.querySelector('input[name="paymentOption"]:checked').value;

        if (razorpayOption === 'razorpay') {
            // Razorpay option is selected, proceed with Razorpay payment
            console.log("razzz");
            confirmRazorpayPayment();
        } else if (razorpayOption === 'COD') {
            // COD option is selected, proceed with COD
            console.log('Proceeding with COD...');
            submitForm();
        }
        else if (razorpayOption === 'wallet') {
            // wallet option is selected, proceed with COD
            console.log('Proceeding with wallet...');
            submitForm();
        }
        
    }

    


	function confirmRazorpayPayment() {


     // Prevent default form submission behavior
     event.preventDefault();

	  // Fetch order details from the server
  
    
	  fetch('/create-razorpay-order', {
		method: 'POST',
		headers: {
		  'Content-Type': 'application/json',
		}
	  })
   
	  .then(response => response.json())
	  .then(order => {
      console.log("kk")
		// Log order details for debugging
		console.log('Received order details:', order);
		console.log("payment order created successfully....")
		// Configure Razorpay button
		var options = {
		  key: '<%=razorpaykey %>',
		  amount: order.amount,
		  currency: order.currency,
		  order_id: order.id,
		  name: 'Funky.com',
		  description: 'Order Payment',
		  handler: function (response) {
			// Handle successful payment
			console.log('Razorpay payment success:', response);
  
			// Call the create-order API after successful payment
			createOrder(order.id); // Assuming order.id is the Razorpay order ID
		  document.getElementById('checkoutForm').submit();
    
    },
		  prefill: {
			name: 'User Name',
			email: 'user@example.com',
			contact: '1234567890',
		  },
		  notes: {
			address: 'User Address',
		  },
		  theme: {
			color: '#012652',
		  },
		};
  
		var rzp = new Razorpay(options);
		rzp.open();
	  })
	  .catch(error => {
		console.error('Error fetching Razorpay order:', error);
		// Handle error
	  });
	}

  function submitForm() {
        // Manually submit the form
        
        document.getElementById('checkoutForm').submit();
    }

  
	function createOrder(razorpayOrderId) {
	  // Call the /create-order API with the Razorpay order ID
	  fetch('/checkout', {
		method: 'POST',
		headers: {
		  'Content-Type': 'application/json',
		},
	  })
	  .then(response => response.json())
	  .then(result => {
		// Handle the response from the create-order API
		console.log("ORder creating success......real product order")
		console.log('Order creation response:', result);
  
		
		// Optionally, redirect to an order confirmation page
		if(result.success){
			console.log('Redirecting to order confirmation page...');
		window.location.href = '/order-confirmation';
		}else{
			console.error("Error creating order: ", result.error)
      document.getElementById("showError").style.display = 'block';
		}
	  })
	  .catch(error => {
		console.error('Error creating order:', error);
		// Handle error
	  });
	}
  </script>





<!-- Bootstrap JS and Popper.js -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>



<%- include('../layouts/footer.ejs') %>



